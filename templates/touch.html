<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Beristales — Touch Typing Mode</title>
<style>
:root{
  --bg:#111;
  --panel:#202225;
  --muted:#bbb;
  --accent:#4CAF50;
  --bad:#f55;
  --good:#4CAF50;
  --text:#eee;
}
html,body{height:100%;margin:0;font-family:"Segoe UI", Roboto, Arial, sans-serif;background:var(--bg);color:var(--text);}
header{padding:36px 20px 6px;text-align:center;}
header h1{margin:0;font-size:2.5rem;color:var(--text);}
header p{margin:6px 0 0;color:#ccc;}
.container{max-width:1000px;width:94%;margin:20px auto;}
.panel{background:var(--panel);border-radius:12px;padding:18px;box-shadow:0 6px 24px rgba(0,0,0,0.6);}
#text-area{
  font-size:2.2rem;
  line-height:2.8rem;
  white-space:pre-wrap;
  text-align:center;
  min-height:140px;
  padding:20px;
  border-radius:8px;
}
#text-area span.correct{color:var(--good);}
#text-area span.incorrect{color:var(--bad);}
#text-area span.current{border-left:3px solid var(--text);animation:blink 1s steps(1) infinite;}
@keyframes blink{0%,50%{border-color:var(--text);}50.01%,100%{border-color:transparent;}}
.stats{display:flex;gap:18px;align-items:center;margin-top:16px;color:var(--muted);font-size:1rem;justify-content:center}
.stat{background:#161616;padding:8px 14px;border-radius:8px;border:1px solid #2b2b2b}
button{background:var(--accent);color:#fff;border:0;padding:12px 18px;border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem}
#ai-panel{margin-top:20px;background:#141414;padding:14px;border-radius:10px;border:1px solid #2b2b2b;color:var(--muted);display:none}
#ai-panel h3{margin:0 0 10px;color:var(--text);font-size:1.1rem}
#ai-panel ul{margin:8px 0 0;padding-left:18px}
#overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);
  display:none;justify-content:center;align-items:center;flex-direction:column;color:#fff;z-index:9999;
}
#overlay button{margin-top:20px;font-size:1.2rem;padding:14px 22px;}
footer{margin:26px 0 40px;color:#9a9a9a;text-align:center}
</style>
</head>
<body>

<header>
  <h1>Beristales — Touch Typing Mode</h1>
  <p>Type the sentences shown. After each one, AI will give feedback.</p>
</header>

<div class="container">
  <div class="panel">
    <div id="text-area" tabindex="0" aria-label="Typing area"></div>

    <div class="stats">
      <div class="stat">WPM: <span id="wpm">0</span></div>
      <div class="stat">Accuracy: <span id="accuracy">0%</span></div>
      <div class="stat">Typed: <span id="typed">0</span></div>
      <div class="stat">Correct: <span id="correct">0</span></div>
    </div>

    <div style="text-align:center;margin-top:20px">
      <button id="startBtn">Start Practice</button>
    </div>

    <div id="ai-panel">
      <h3>AI Feedback</h3>
      <div class="feedback" id="ai-feedback"></div>
      <div id="ai-suggestions"></div>
    </div>

    <div class="stats muted">
      Round <span id="round-index">0</span> / <span id="round-count">0</span>
    </div>
  </div>
</div>

<div id="overlay">
  <h2>You can start learning from your mistakes!</h2>
  <button id="overlayBtn">Start Learning</button>
</div>

<footer>AI adapts after each sentence. Keep typing until accuracy improves.</footer>

<script>
const startBtn = document.getElementById('startBtn');
const overlay = document.getElementById('overlay');
const overlayBtn = document.getElementById('overlayBtn');

const textArea = document.getElementById('text-area');
const wpmEl = document.getElementById('wpm');
const accuracyEl = document.getElementById('accuracy');
const typedEl = document.getElementById('typed');
const correctEl = document.getElementById('correct');
const aiPanel = document.getElementById('ai-panel');
const aiFeedback = document.getElementById('ai-feedback');
const aiSuggestions = document.getElementById('ai-suggestions');
const roundIndexEl = document.getElementById('round-index');
const roundCountEl = document.getElementById('round-count');

let mode = "practice"; // practice or tutor
let rounds = [
 "The quick brown fox jumps over the lazy dog.",
 "Pack my box with five dozen liquor jugs.",
 "Sphinx of black quartz, judge my vow.",
 "How quickly daft jumping zebras vex."
];

let finalAssessments = [
  "Jackdaws love my big sphinx of quartz.",
  "The five boxing wizards jump quickly.",
  "How vexingly quick daft zebras jump.",
  "Bright vixens jump; dozy fowl quack.",
  "Quick zephyrs blow, vexing daft Jim.",
  "Sphinx of black quartz, judge my vow.",
  "Two driven jocks help fax my big quiz.",
  "Crazy Fredrick bought many very exquisite opal jewels.",
  "We promptly judged antique ivory buckles for the next prize.",
  "Amazingly few discotheques provide jukeboxes."
];

let roundPos=0, spans=[], caretIndex=0, startTime=null, totalTyped=0, correctChars=0, running=false;
let mistakes={};
let tutorWords = [];
let tutorIndex = 0;

function renderRound(){
  textArea.innerHTML = "";
  const s = rounds[roundPos];
  for(let ch of s.split("")){
    const sp = document.createElement('span'); sp.textContent = ch; textArea.appendChild(sp);
  }
  spans = [...textArea.querySelectorAll('span')];
  caretIndex = 0; updatePointer();
}

function updatePointer(){spans.forEach(sp=>sp.classList.remove('current')); if(spans[caretIndex])spans[caretIndex].classList.add('current');}
function resetStats(){startTime=null; totalTyped=0; correctChars=0; updateStatsUI();}
function updateStatsUI(){
  typedEl.textContent=totalTyped;
  correctEl.textContent=correctChars;
  const expectedLen = spans.length;
  const totalKeys = Math.max(totalTyped, expectedLen);
  const acc = totalKeys ? Math.round((correctChars/totalKeys)*100) : 0;
  accuracyEl.textContent = acc+"%";
  if(!startTime){ wpmEl.textContent="0"; return; }
  const minutes = Math.max((Date.now()-startTime)/60000, 1/60);
  const wpm = Math.max(0,Math.round((correctChars/5)/minutes));
  wpmEl.textContent = wpm;
}

document.addEventListener('keydown', async e=>{
  if(!running) return; const k = e.key;
  if(["Shift","Control","Alt","Meta","Tab","CapsLock"].includes(k)) return;
  if(!startTime && k!=="Backspace") startTime=Date.now();
  if(k==="Backspace"){
    if(caretIndex>0){
      caretIndex--;
      let prev=spans[caretIndex];
      if(prev.classList.contains('correct')) correctChars--;
      prev.classList.remove('correct','incorrect');
      totalTyped--;
      updatePointer(); updateStatsUI();
    }
    e.preventDefault(); return;
  }
  if(caretIndex>=spans.length){e.preventDefault(); return;}
  const exp = spans[caretIndex].textContent;
  if(k.length===1 || k===" "){
    if(k===exp){spans[caretIndex].classList.add('correct'); if(exp!==" ") correctChars++;}
    else{
      spans[caretIndex].classList.add('incorrect');
      mistakes[exp] = mistakes[exp]? mistakes[exp]+1 : 1;
    }
    caretIndex++; totalTyped++; updatePointer(); updateStatsUI();
  }
  if(caretIndex>=spans.length){ await finishRound();}
  e.preventDefault();
});

async function finishRound(){
  running=false;
  const acc=parseInt(accuracyEl.textContent);
  aiPanel.style.display="block";
  aiFeedback.textContent=`You completed the sentence! Accuracy: ${acc}%`;
  aiSuggestions.innerHTML="";
  if(Object.keys(mistakes).length>0){
    const ul = document.createElement('ul');
    for(let k in mistakes){
      let li = document.createElement('li'); li.textContent = `${k} — ${mistakes[k]} time(s)`; ul.appendChild(li);
    }
    aiSuggestions.appendChild(ul);
  }

  if(mode === "practice"){
    roundPos++;
    if(roundPos < rounds.length){
      roundIndexEl.textContent = roundPos+1;
      renderRound(); resetStats(); running=true;
    } else {
      overlay.style.display="flex"; // show tutor overlay only after practice rounds
    }
  } else if(mode === "tutor"){
    startTutorWord();
  }
}

startBtn.addEventListener('click',()=>{
  roundPos=0; roundCountEl.textContent=rounds.length; roundIndexEl.textContent=1;
  renderRound(); resetStats(); running=true; aiPanel.style.display="none"; startBtn.disabled=true;
});

overlayBtn.addEventListener('click', async ()=>{
  overlay.style.display="none";
  mode="tutor";
  const res = await fetch('/tutor_words',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({mistakes:mistakes})
  });
  const data = await res.json();
  tutorWords = data.words;
  tutorIndex=0;
  startTutorWord();
});

function startTutorWord(){
  if(tutorIndex >= tutorWords.length){
    // Tutor finished, load final assessment
    const randomIndex = Math.floor(Math.random() * finalAssessments.length);
    const sentence = finalAssessments[randomIndex];
    rounds = [sentence];
    roundPos = 0;
    roundCountEl.textContent = 1;
    roundIndexEl.textContent = 1;
    renderRound();
    resetStats();
    running = true;
    mode = "practice"; // back to practice mode for assessment
    aiFeedback.textContent = "Final assessment started!";
    aiSuggestions.innerHTML="";
    return;
  }

  const word = tutorWords[tutorIndex];
  textArea.innerHTML="";
  for(let ch of word.split("")){const sp=document.createElement('span'); sp.textContent=ch; textArea.appendChild(sp);}
  spans=[...textArea.querySelectorAll('span')];
  caretIndex=0; updatePointer(); resetStats(); running=true;
  aiPanel.style.display="block"; aiFeedback.textContent=`Practice this word: ${word}`; aiSuggestions.innerHTML="";
  tutorIndex++;
}
</script>

</body>
</html>
